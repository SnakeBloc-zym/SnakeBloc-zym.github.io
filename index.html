<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>陨星</title>
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/katex.min.css">
	<link rel="stylesheet"
		href="https://cdn.jsdmirror.com/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
	<script src="https://cdn.jsdmirror.com/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
	<link rel="shortcut icon" href="https://cdn.luogu.com.cn/upload/image_hosting/t7nh8xao.png">
	<script src="https://cdn.jsdmirror.com/npm/anchor-js/anchor.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css">
	<script src="https://cdn.jsdmirror.com/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/lxgw-wenkai-screen-webfont@1.7.0/style.min.css">
	<script src="https://cdn.jsdmirror.com/npm/@supabase/supabase-js@2"></script>
	<style>
		@font-face {
			font-family: 'Caveat';
			src: url('https://cdn.jsdmirror.com/gh/googlefonts/caveat/fonts/ttf/Caveat-Regular.ttf') format('truetype');
			font-weight: 400;
			font-style: normal;
			font-display: swap
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			min-height: 100vh;
			padding: 20px;
			font-family: LXGW Wenkai Screen;
		}

		.header {
			color: #555;
			padding: 15px 0;
			background: linear-gradient(90deg, #ffffff 0%, #f0f8ff 100%);
			box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: fixed;
			width: 100%;
			z-index: 1000;
			margin-left: -20px !important;
			top: 0
		}

		.logo {
			font-size: 32px;
			font-weight: bold;
			margin-left: 20px;
			font-family: 'Caveat'
		}

		.container {
			margin-top: 50px !important;
			margin-left: 70px !important;
			margin: 0 auto;
		}

		.subtitle {
			font-size: 1.2rem;
			margin-bottom: 30px;
		}

		.content-grid {
			display: grid;
			grid-template-columns: 1fr;
			gap: 30px;
		}

		@media (min-width: 768px) {
			.content-grid {
				grid-template-columns: repeat(2, 1fr);
			}

			.intro-box {
				grid-column: 1 / 3;
			}

			.new-problems-box {
				grid-column: 1 / 3;
			}

			.comments-box {
				grid-column: 1 / 3;
			}
		}

		h1 {
			color: #2c3e50;
			border-bottom: 2px solid #3498db;
			padding-bottom: 10px;
		}

		.box {
			border-radius: 15px;
			padding: 25px;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.box-title {
			font-size: 1.8rem;
			margin-bottom: 20px;
			border-bottom: 2px solid rgba(106, 140, 255, 0.3);
			padding-bottom: 10px;
			display: flex;
			align-items: center;
		}

		.box-title i {
			margin-right: 10px;
			font-size: 1.5rem;
		}

		.markdown-content {
			line-height: 1.6;
		}

		.markdown-content h1,
		.markdown-content h2,
		.markdown-content h3 {
			margin: 20px 0 10px 0;
		}

		.markdown-content p {
			margin-bottom: 15px;
		}

		ul {
			display: block;
			margin-block-start: 1em;
			margin-block-end: 1em;
			padding-inline-start: 40px;
			unicode-bidi: isolate;
		}

		ol {
			display: block;
			margin-block-start: 1em;
			margin-block-end: 1em;
			padding-inline-start: 40px;
			unicode-bidi: isolate;
		}

		.problem-list {
			list-style-type: none;
		}

		.problem-item {
			padding: 15px;
			margin-bottom: 15px;
			background: rgba(255, 255, 255, 0.5);
			border-radius: 8px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(100, 100, 200, 0.2);
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.problem-item:hover {
			transform: translateY(-5px);
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
		}

		.problem-link {
			color: #6a8cff;
			text-decoration: none;
			font-size: 1.1rem;
			display: block;
			margin-bottom: 5px;
		}

		.problem-link:hover {
			color: #8aafff;
			text-decoration: underline;
		}

		.problem-meta {
			font-size: 0.9rem;
			color: #a0a0c0;
			display: flex;
			justify-content: space-between;
		}

		.giscus-comments {
			min-height: 400px;
		}

		footer {
			text-align: center;
			margin-top: 50px;
			padding: 20px;
			color: #7070a0;
			font-size: 0.9rem;
		}

		.loading {
			text-align: center;
			padding: 20px;
			color: #a0a0c0;
		}

		.error {
			color: #ff6b6b;
			padding: 10px;
			background: rgba(255, 107, 107, 0.1);
			border-radius: 5px;
			margin: 10px 0;
		}

		pre code {
			font-family: 'Consolas' !important;
			display: block !important;
			padding: 12px !important;
			padding-left: 20px !important;
			margin: 2rem 0 !important;
			background: #f8fafc !important;
			border-radius: 10px !important;
			border: 1px solid #e2e8f0 !important;
			color: #1e1e1e !important;
			overflow-x: auto !important;
			overflow-y: auto !important;
			line-height: 1.6 !important;
			font-size: 0.95rem !important;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
		}

		table {
			border-collapse: collapse !important;
			border-spacing: 0 !important;
			overflow-x: auto;
			min-width: 600px !important;
			font-size: 1rem !important;
			width: 100%;
			margin: 2rem 0;
			border-radius: 10px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			border: 1px solid #e2e8f0;
			background: white;
		}

		thead {
			display: table-header-group;
			vertical-align: middle;
			unicode-bidi: isolate;
			border-color: inherit;
			border-radius: 10px;
		}

		tbody {
			border-radius: 10px;
		}

		tr {
			display: table-row;
			vertical-align: inherit;
			unicode-bidi: isolate;
			border-color: inherit;
		}

		th {
			background: #f8fafc !important;
			font-weight: 600 !important;
			color: #374151 !important;
			border-bottom: 2px solid #e2e8f0 !important;
		}

		th,
		td {
			padding: 12px 16px !important;
			font-size: 1rem !important;
			border-bottom: 1px solid #e2e8f0;
			border-right: 1px solid rgba(34, 36, 38, .1);
			white-space: nowrap;
		}

		table tbody tr:hover {
			background-color: #f8fafc;
		}

		.codecopy-btn {
			opacity: 0.7 !important;
			min-height: 1em;
			outline: 0;
			vertical-align: baseline;
			position: absolute;
			top: 10px !important;
			right: 10px !important;
			background: #f8fafc;
			padding: 6px 10px !important;
			color: rgba(0, 0, 0, 0.6);
			border: 1px solid rgba(0, 0, 0, 0.1);
			box-shadow: transparent 0px 0px 0px 1px inset, rgba(34, 36, 38, 0.15) 0px 0px 0px 0px inset;
			cursor: pointer;
			z-index: 10;
			text-transform: none;
			text-shadow: none;
			font-weight: 700;
			line-height: 1em;
			font-style: normal;
			text-align: center;
			text-decoration: none;
			border-radius: .28571429rem;
			font-size: 0.8rem !important;
			display: inline-block !important;
			padding-block: 1px;
			padding-inline: 6px;
			margin: 0 .25em 0 0;
		}

		.codecopy-btn icon {
			font-weight: 0.8rem !important;
		}

		.codecopy-btn:active {
			background-color: rgb(186, 187, 188);
			color: rgba(0, 0, 0, 0.9);
		}

		.codecopy-btn:hover {
			background: #fff;
			transform: translateY(-1px);
			background-color: rgb(202, 203, 205);
			box-shadow: transparent 0px 0px 0px 1px inset, rgba(34, 36, 38, 0.15) 0px 0px 0px 0px inset;
			color: rgba(0, 0, 0, 0.8);
		}

		.codecopy-btn:focus {
			background-color: rgb(202, 203, 205);
			color: rgba(0, 0, 0, 0.8);
		}

		.sidebar {
			width: 70px;
			height: calc(100vh - 70px);
			position: fixed;
			background: linear-gradient(180deg, #ffffff 0%, #f0f8ff 100%);
			border-right: 2px solid #e6f3ff;
			box-shadow: 2px 0 10px rgba(135, 206, 250, 0.1);
			transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			overflow: hidden;
			backdrop-filter: blur(10px);
			z-index: 900;
			margin-top: 50px;
			margin-left: -20px;
			padding-top: 10px;
			color: #2c3e50;
		}

		.sidebar.expanded {
			width: 250px
		}

		.sidebar-item {
			display: flex;
			align-items: center;
			padding: 15px 23px;
			cursor: pointer;
		}

		.sidebar-item i {
			margin-right: 15px;
			font-size: 18px;
			min-width: 20px;
			width: 20px;
			text-align: center;
		}

		.sidebar-item span {
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s ease, visibility 0.3s ease;
			white-space: nowrap;
			overflow: hidden;
		}

		.sidebar.expanded .sidebar-item span {
			opacity: 1;
			visibility: visible;
		}

		.sidebar-item:hover {
			background-color: #f9f9f9
		}

		.user-profile {
			text-align: center;
			padding: 20px;
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			margin-bottom: 20px;
		}

		.user-avatar {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			object-fit: cover;
			margin-bottom: 15px;
			border: 3px solid #6a8cff;
		}

		.user-username {
			font-size: 1.5rem;
			font-weight: bold;
			margin-bottom: 5px;
			color: #2c3e50;
		}

		.user-signature {
			font-style: italic;
			color: #6a8cff;
			margin-bottom: 10px;
		}

		.user-bio {
			color: #666;
			margin-bottom: 15px;
		}

		.auth-section {
			position: fixed;
			top: 15px;
			right: 20px;
			z-index: 1001;
		}

		.auth-buttons {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.auth-button {
			padding: 8px 16px;
			border: none;
			border-radius: 20px;
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.3s ease;
		}

		.login-btn {
			background: #6a8cff;
			color: white;
		}

		.logout-btn {
			background: #ff6b6b;
			color: white;
		}

		.user-info {
			display: flex;
			align-items: center;
			gap: 10px;
			color: #555;
		}

		.user-info img {
			width: 30px;
			height: 30px;
			border-radius: 50%;
			object-fit: cover;
		}

		.clipboard-box {
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			padding: 25px;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.clipboard-form {
			margin-bottom: 20px;
		}

		.clipboard-form input,
		.clipboard-form textarea {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-family: LXGW Wenkai Screen;
		}

		.clipboard-form textarea {
			min-height: 100px;
			resize: vertical;
		}

		.clipboard-item {
			background: rgba(255, 255, 255, 0.5);
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 10px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(100, 100, 200, 0.2);
		}

		.clipboard-title {
			font-weight: bold;
			margin-bottom: 5px;
			color: #2c3e50;
		}

		.clipboard-content {
			margin-bottom: 10px;
			white-space: pre-wrap;
		}

		.clipboard-actions {
			display: flex;
			gap: 10px;
		}

		.clipboard-btn {
			padding: 5px 10px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.8rem;
		}

		.edit-btn {
			background: #6a8cff;
			color: white;
		}

		.delete-btn {
			background: #ff6b6b;
			color: white;
		}

		.user-profile-edit {
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			padding: 25px;
			margin-left: 80px;
			margin-top: 20px;
		}

		.profile-form input,
		.profile-form textarea {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-family: LXGW Wenkai Screen;
		}

		.profile-form textarea {
			min-height: 100px;
			resize: vertical;
		}

		.profile-btn {
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			background: #6a8cff;
			color: white;
			margin-right: 10px;
		}

		.post-form {
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			padding: 25px;
			margin-top: 20px;
		}

		.post-form input,
		.post-form textarea {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-family: LXGW Wenkai Screen;
		}

		.post-form textarea {
			min-height: 200px;
			resize: vertical;
		}

		.comment-box {
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			padding: 25px;
			margin-top: 20px;
		}

		.comment-form textarea {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			margin-top: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-family: LXGW Wenkai Screen;
			min-height: 80px;
			resize: vertical;
		}

		#comments-list {
			margin-top: 20px;
		}

		.comment-item {
			background: rgba(255, 255, 255, 0.5);
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(100, 100, 200, 0.2);
		}

		.comment-header {
			display: flex;
			align-items: center;
			margin-bottom: 10px;
			gap: 10px;
		}

		.comment-avatar {
			width: 30px;
			height: 30px;
			border-radius: 50%;
			object-fit: cover;
		}

		.comment-username {
			font-weight: bold;
			color: #2c3e50;
		}

		.comment-date {
			color: #888;
			font-size: 0.8rem;
		}

		.comment-content {
			line-height: 1.6;
		}

		.comment-actions {
			margin-top: 10px;
			text-align: right;
		}

		.reply-btn {
			background: #6a8cff;
			color: white;
			border: none;
			padding: 5px 10px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.8rem;
		}

		.reply-form {
			margin-top: 15px;
			padding: 10px;
			background: rgba(255, 255, 255, 0.3);
			border-radius: 5px;
		}

		.reply-form textarea {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-family: LXGW Wenkai Screen;
			min-height: 60px;
			resize: vertical;
		}

		.reply-form button {
			margin-top: 5px;
			padding: 5px 10px;
			background: #6a8cff;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.posts-list {
			background: rgba(255, 255, 255, 0.7);
			border-radius: 15px;
			padding: 25px;
			margin-top: 20px;
		}

		.post-item {
			background: rgba(255, 255, 255, 0.5);
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(100, 100, 200, 0.2);
		}

		.post-title {
			font-weight: bold;
			margin-bottom: 5px;
			color: #2c3e50;
		}

		.post-meta {
			color: #888;
			font-size: 0.8rem;
			margin-bottom: 10px;
		}

		.post-content {
			margin-bottom: 10px;
		}

		a {
			color: #6a8cff;
			text-decoration: none;
			font-size: 1.1rem;
			display: block;
			margin-bottom: 5px;
		}

		.intro-box>div:first-of-type {
			display: flex;
			align-items: center;
			gap: 15px;
			margin-bottom: 15px;
		}

		.intro-box>div:first-of-type p {
			margin: 0;
			font-size: 1.1rem;
			color: #2c3e50;
		}

		.intro-box h1 {
			border-bottom: 2px solid rgba(106, 140, 255, 0.3);
		}

		.odl {
			border-bottom: 2px solid rgba(106, 140, 255, 0.3);
		}
	</style>
	<style>
		.star {
			margin: auto;
			width: 16em;
			height: 16em;
		}

		.star__stroke {
			--dur: 2s;
			animation: stroke1 var(--dur) linear infinite;
		}

		.star__stroke--2 {
			animation-name: stroke2;
			animation-delay: calc(var(--dur) / -2);
		}

		.star__stroke--3 {
			animation-name: stroke3;
			animation-direction: reverse;
		}

		.star__stroke--4 {
			animation-name: stroke4;
			animation-delay: calc(var(--dur) / -2);
			animation-direction: reverse;
		}

		@keyframes stroke1 {
			from {
				stroke-dashoffset: 0;
			}

			to {
				stroke-dashoffset: 124;
			}
		}

		@keyframes stroke2 {
			from {
				stroke-dashoffset: 0;
			}

			to {
				stroke-dashoffset: 248;
			}
		}

		@keyframes stroke3 {
			from {
				stroke-dashoffset: 0;
			}

			to {
				stroke-dashoffset: 372;
			}
		}

		@keyframes stroke4 {
			from {
				stroke-dashoffset: 0;
			}

			to {
				stroke-dashoffset: 496;
			}
		}
	</style>
</head>

<body>
	<header class="header">
		<div class="logo">YunXing</div>
	</header>
	<div class="sidebar" id="sidebar">
		<div class="sidebar-item" onclick="navigateTo('/')"><i class="fas fa-home"></i><span>首页</span></div>
		<div class="sidebar-item" onclick="navigateTo('/problemlist')"><i class="fas fa-book"></i><span>题库</span>
		</div>
	</div>
	<div class="container">
		<div class="content-grid">
			<div class="box intro-box" style="display: none;">
				<h1 class="box-title"> </h1>
				<div>
					<img src="https://cdn.luogu.com.cn/upload/image_hosting/t7nh8xao.png?x-oss-process=image/rounded-corners,r_90"
						width="100" height="100">
					<p><span class="odl">Our Card:</span><br><span class="odl">Team: YunXing（陨星）</span><br><span
							class="odl">Owner: lwp123456lpw</span><br><span class="odl">Position: Hydro</span></p>
				</div>
				<h1 class="box-title"> </h1>
				<div class="markdown-content" id="intro-content">
					<div class="loading">加载中...</div>
				</div>
			</div>
			<div class="box new-problems-box" style="display: none;">
				<h2 class="box-title"><i class="fas fa-list"></i> 最新题目</h2>
				<div id="new-problems-content">
					<div class="loading">加载中...</div>
				</div>
			</div>
			<div class="box comments-box" style="display: none;">
				<h2 class="box-title"><i class="fas fa-comments"></i> 评论</h2>
				<span style="color: #e6edf3;">此功能还未上线，敬请期待……</span>
			</div>
		</div>
		<footer>
			<p>YunXing &copy; 2025</p>
		</footer>
	</div>
	<script src="https://cdn.jsdmirror.com/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/katex.min.js"></script>
	<script src="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
	<script>
		marked.setOptions({
			highlight: function (code, lang) {
				if (lang && hljs.getLanguage(lang)) {
					return hljs.highlight(code, { language: lang }).value;
				}
				return hljs.highlightAuto(code).value;
			},
			gfm: true
		});
		document.querySelector('.logo').addEventListener('click', function () {
			window.location.href = window.location.origin + window.location.pathname;
		});
		function navigateTo(path) {
			if (path === '/') {
				window.location.href = window.location.origin + window.location.pathname;
			} else if (path === '/problemlist') {
				window.location.href = window.location.origin + window.location.pathname + '?page=problemlist';
				showProblemList();
			} else if (path === '/clipboard') {
				if (currentUser) {
					window.location.href = '?page=clipboard';
					showClipboard();
				} else {
					alert('请先登录');
				}
			} else if (path === '/posts') {
				window.location.href = '?page=posts';
				showPosts();
			} else if (path === '/create-post') {
				if (currentUser) {
					window.location.href = '?page=create-post';
					createPost();
				} else {
					alert('请先登录');
				}
			}
		}
		const supabaseUrl = 'https://fzwtrdzbklityqwuozhn.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d3RyZHpia2xpdHlxd3VvemhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMzk4OTcsImV4cCI6MjA3NDYxNTg5N30.QBlEVFkEtLAi8_HRyeqLIXE49jZZTRJzt_5pJfwrYO0';
		const Supabase = supabase.createClient(supabaseUrl, supabaseKey);
		let currentUser = null;
		async function initAuth() {
			const { data: { user } } = await Supabase.auth.getUser();
			currentUser = user;
			updateAuthUI();
			Supabase.auth.onAuthStateChange((event, session) => {
				currentUser = session?.user || null;
				updateAuthUI();
			});
		}
		async function updateAuthUI() {
			const authSection = document.createElement('div');
			authSection.className = 'auth-section';
			authSection.id = 'auth-section';
			if (currentUser) {
				const { data, error } = await Supabase
					.from('users')
					.select('*')
					.ilike('username', currentUser.user_metadata?.username)
					.limit(1);
				if (error) {
					throw error;
				}
				if (!data || data.length === 0) {
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `用户 ${currentUser.user_metadata?.username} 不存在。`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				const user = data[0];
				const displayName = currentUser.user_metadata?.username ||
					currentUser.user_metadata?.full_name ||
					currentUser.email;
				const avatarUrl = user.avatar_url || 'https://cdn.luogu.com.cn/upload/image_hosting/t7nh8xao.png';
				authSection.innerHTML = `
            <div class="user-info">
                <img src="${avatarUrl}" alt="Avatar" class="user-avatar-clickable" data-username="${displayName}">
                <span class="username-clickable" data-username="${displayName}">${displayName}</span>
                <button class="auth-button logout-btn" onclick="logout()">退出</button>
            </div>
        `;
				const avatarElement = authSection.querySelector('.user-avatar-clickable');
				const usernameElement = authSection.querySelector('.username-clickable');
				if (avatarElement) {
					avatarElement.addEventListener('click', (e) => {
						e.preventDefault();
						window.location.href = `${window.location.origin}${window.location.pathname}?user=${encodeURIComponent(displayName)}`;
					});
				}
				if (usernameElement) {
					usernameElement.addEventListener('click', (e) => {
						e.preventDefault();
						window.location.href = `${window.location.origin}${window.location.pathname}?user=${encodeURIComponent(displayName)}`;
					});
				}
			} else {
				authSection.innerHTML = `
            <div class="auth-buttons">
                <button class="auth-button login-btn" onclick="showLoginModal()">登录</button>
            </div>
        `;
			}
			const existingAuth = document.getElementById('auth-section');
			if (existingAuth) {
				existingAuth.remove();
			}
			document.body.appendChild(authSection);
		}
		function showLoginModal() {
			const modal = document.createElement('div');
			modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;
			modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 20px;">登录</h3>
            <div>
                <input type="email" id="login-email" placeholder="邮箱" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="password" id="login-password" placeholder="密码" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button onclick="loginUser()" style="width: 100%; padding: 10px; background: #6a8cff; color: white; border: none; border-radius: 5px; cursor: pointer;">登录</button>
                <button onclick="showSignupModal()" style="width: 100%; padding: 10px; margin-top: 10px; background: #f0f0f0; color: #333; border: none; border-radius: 5px; cursor: pointer;">注册</button>
            </div>
            <button onclick="closeModal(this)" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
        </div>
    `;
			document.body.appendChild(modal);
		}
		function showSignupModal() {
			const modal = document.createElement('div');
			modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;
			modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 400px; max-width: 90%;">
            <h3 style="margin-bottom: 20px;">注册</h3>
            <div>
                <input type="email" id="signup-email" placeholder="邮箱" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="password" id="signup-password" placeholder="密码" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="text" id="signup-username" placeholder="用户名" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button onclick="signupUser()" style="width: 100%; padding: 10px; background: #6a8cff; color: white; border: none; border-radius: 5px; cursor: pointer;">注册</button>
            </div>
            <button onclick="closeModal(this)" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
        </div>
    `;
			document.body.appendChild(modal);
		}
		function closeModal(button) {
			if (button) {
				const modal = button.closest('div[style*="position: fixed"]');
				if (modal) {
					modal.remove();
				}
			}
		}
		async function loginUser() {
			const email = document.getElementById('login-email').value;
			const password = document.getElementById('login-password').value;
			try {
				const { error } = await Supabase.auth.signInWithPassword({
					email,
					password
				});
				if (error) throw error;
				const modal = document.querySelector('div[style*="position: fixed"]');
				if (modal) {
					modal.remove();
				}
			} catch (error) {
				alert('登录失败: ' + error.message);
			}
		}
		async function signupUser() {
			const email = document.getElementById('signup-email').value;
			const password = document.getElementById('signup-password').value;
			const username = document.getElementById('signup-username').value;
			if (!username) {
				alert('请输入用户名');
				return;
			}
			try {
				const { data: { user }, error } = await Supabase.auth.signUp({
					email,
					password,
					options: {
						data: {
							username: username
						}
					}
				});
				if (error) {
					throw error;
				}
				alert('注册成功！请检查您的邮箱以确认账户。');
				closeModal(document.querySelector('div[style*="position: fixed"] button[onclick*="closeModal"]'));
			} catch (error) {
				alert('注册失败: ' + error.message);
			}
		}
		async function logout() {
			try {
				await Supabase.auth.signOut();
				currentUser = null;
				updateAuthUI();
				const currentUrl = new URL(window.location.href);
				if (currentUrl.searchParams.size > 0) {
					currentUrl.search = '';
					window.location.href = currentUrl.toString();
				} else {
					window.location.reload();
				}
			} catch (error) {
				console.error('登出过程中发生错误:', error);
			}
		}
		async function showUserProfile(username) {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			try {
				const { data, error } = await Supabase
					.from('users')
					.select('*')
					.ilike('username', username)
					.limit(1);
				if (error) {
					throw error;
				}
				if (!data || data.length === 0) {
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `用户 ${username} 不存在。`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				const user = data[0];
				if (!user) {
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `获取用户资料失败: 数据为空。`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				const profileBox = document.createElement('div');
				profileBox.className = 'user-profile';
				const profileContentHtml = marked.parse(user.profile_content || '');
				profileBox.innerHTML = `
            <img src="${user.avatar_url || 'https://cdn.luogu.com.cn/upload/image_hosting/t7nh8xao.png'}" alt="Avatar" class="user-avatar">
            <h2 class="user-username">${user.username}</h2>
            <p class="user-signature">${user.signature || ''}</p>
            <p class="user-bio">${user.bio || ''}</p>
            <div class="markdown-content" id="profile-content">${profileContentHtml}</div>
        `;
				document.querySelector('.content-grid').insertBefore(profileBox, document.querySelector('.comments-box'));
				await renderMath(profileBox);
				addCopyButtonsToElement(profileBox);
				if (currentUser && currentUser.email && user.email && currentUser.email === user.email) {
					const editBtn = document.createElement('button');
					editBtn.textContent = '编辑个人资料';
					editBtn.className = 'profile-btn';
					editBtn.onclick = () => showProfileEdit(user);
					profileBox.appendChild(editBtn);
				}
			} catch (error) {
				const errorBox = document.createElement('div');
				errorBox.className = 'error';
				errorBox.textContent = `加载用户资料失败: ${error.message}`;
				document.querySelector('.content-grid').appendChild(errorBox);
			}
		}
		function showProfileEdit(user) {
			const existingEditBox = document.querySelector('.user-profile-edit');
			if (existingEditBox) {
				existingEditBox.remove();
			}
			const editBox = document.createElement('div');
			editBox.className = 'user-profile-edit';
			editBox.innerHTML = `
        <h3>编辑个人资料</h3>
        <form class="profile-form" id="profile-form">
            <input type="text" id="edit-username" placeholder="用户名" value="${user.username}">
            <input type="text" id="edit-avatar" placeholder="头像URL" value="${user.avatar_url || ''}">
            <input type="text" id="edit-signature" placeholder="个性签名" value="${user.signature || ''}">
            <input type="text" id="edit-bio" placeholder="个人简介" value="${user.bio || ''}">
            <textarea id="edit-profile-content" placeholder="个人介绍">${user.profile_content || ''}</textarea>
            <button type="button" class="profile-btn" onclick="saveProfile()">保存</button>
        </form>
    `;
			document.querySelector('.content-grid').appendChild(editBox);
		}
		async function saveProfile() {
			const username = document.getElementById('edit-username').value;
			const avatar = document.getElementById('edit-avatar').value;
			const signature = document.getElementById('edit-signature').value;
			const bio = document.getElementById('edit-bio').value;
			const content = document.getElementById('edit-profile-content').value;
			try {
				const { error } = await Supabase
					.from('users')
					.update({
						username,
						avatar_url: avatar,
						signature,
						bio,
						profile_content: content
					})
					.eq('id', currentUser.id);
				if (error) throw error;
				alert('资料更新成功！');
				window.location.reload();
			} catch (error) {
				alert('更新失败: ' + error.message);
			}
		}
		async function showClipboard() {
			if (!currentUser) {
				alert('请先登录');
				return;
			}
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			const clipboardBox = document.createElement('div');
			clipboardBox.className = 'clipboard-box';
			clipboardBox.innerHTML = `
        <h2 class="box-title"><i class="fas fa-clipboard"></i> 云剪贴板</h2>
        <div class="clipboard-form">
            <input type="text" id="clipboard-title" placeholder="标题">
            <textarea id="clipboard-content" placeholder="内容"></textarea>
            <button class="profile-btn" onclick="createClipboard()">创建</button>
        </div>
        <div id="clipboard-list"></div>
    `;
			document.querySelector('.content-grid').appendChild(clipboardBox);
			loadClipboard();
		}
		async function loadClipboard() {
			if (!currentUser) return;
			try {
				const { data, error } = await Supabase
					.from('clipboards')
					.select('*')
					.eq('user_id', currentUser.id)
					.order('created_at', { ascending: false });
				if (error) throw error;
				const list = document.getElementById('clipboard-list');
				list.innerHTML = '';
				data.forEach(item => {
					const itemDiv = document.createElement('div');
					itemDiv.className = 'clipboard-item';
					const contentHtml = marked.parse(item.content);
					itemDiv.innerHTML = `
                <div class="clipboard-title">${item.title}</div>
                <div class="clipboard-content markdown-content" id="clipboard-content-${item.id}">${contentHtml}</div>
                <div class="clipboard-meta">${new Date(item.created_at).toLocaleString()}</div>
                <div class="clipboard-actions">
                    <button class="clipboard-btn delete-btn" onclick="deleteClipboard('${item.id}')">删除</button>
                </div>
            `;
					list.appendChild(itemDiv);
					const contentElement = document.getElementById(`clipboard-content-${item.id}`);
					if (contentElement) {
						renderMath(contentElement);
					}
				});
			} catch (error) {
				console.error('加载剪贴板失败:', error);
			}
		}
		async function createClipboard() {
			const title = document.getElementById('clipboard-title').value;
			const content = document.getElementById('clipboard-content').value;
			if (!title || !content) {
				alert('请输入标题和内容');
				return;
			}
			try {
				const { error } = await Supabase
					.from('clipboards')
					.insert([{
						user_id: currentUser.id,
						title,
						content
					}]);
				if (error) throw error;
				document.getElementById('clipboard-title').value = '';
				document.getElementById('clipboard-content').value = '';
				loadClipboard();
			} catch (error) {
				alert('创建失败: ' + error.message);
				console.error('创建剪贴板错误:', error);
			}
		}
		async function editClipboard(id, title, content) {
			document.getElementById('clipboard-title').value = title;
			document.getElementById('clipboard-content').value = content;
			window.currentClipboardId = id;
			const form = document.querySelector('.clipboard-form');
			const existingBtn = form.querySelector('.profile-btn');
			if (existingBtn) existingBtn.remove();
			const updateBtn = document.createElement('button');
			updateBtn.className = 'profile-btn';
			updateBtn.textContent = '更新';
			updateBtn.onclick = updateClipboard;
			form.appendChild(updateBtn);
		}
		async function updateClipboard() {
			const id = window.currentClipboardId;
			const title = document.getElementById('clipboard-title').value;
			const content = document.getElementById('clipboard-content').value;
			try {
				const { error } = await Supabase
					.from('clipboards')
					.update({ title, content })
					.eq('id', id);
				if (error) throw error;
				document.getElementById('clipboard-title').value = '';
				document.getElementById('clipboard-content').value = '';
				const form = document.querySelector('.clipboard-form');
				const existingBtn = form.querySelector('.profile-btn');
				if (existingBtn) existingBtn.remove();
				const createBtn = document.createElement('button');
				createBtn.className = 'profile-btn';
				createBtn.textContent = '创建';
				createBtn.onclick = createClipboard;
				form.appendChild(createBtn);
				loadClipboard();
			} catch (error) {
				alert('更新失败: ' + error.message);
			}
		}
		async function deleteClipboard(id) {
			if (!confirm('确定要删除这个项目吗？')) return;
			try {
				const { error } = await Supabase
					.from('clipboards')
					.delete()
					.eq('id', id);
				if (error) throw error;
				loadClipboard();
			} catch (error) {
				alert('删除失败: ' + error.message);
			}
		}
		async function showPosts() {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			const postsBox = document.createElement('div');
			postsBox.className = 'posts-list';
			postsBox.innerHTML = `
        <h2 class="box-title"><i class="fas fa-newspaper"></i> 文章</h2>
        <div id="posts-content">
            <div class="loading">加载中...</div>
        </div>
    `;
			document.querySelector('.content-grid').appendChild(postsBox);
			loadPosts();
		}
		async function loadPosts() {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			try {
				const { data, error } = await Supabase
					.from('posts')
					.select('*, users(username, avatar_url)');
				if (error) throw error;
				const content = document.getElementById('posts-content');
				content.innerHTML = '';
				data.forEach(post => {
					const postDiv = document.createElement('div');
					postDiv.className = 'post-item';
					postDiv.innerHTML = `
                <div class="post-title"><a href="?post=${post.id}">${post.title}</a></div>
                <div class="post-meta">作者: ${post.users?.username} | 发布时间: ${new Date(post.created_at).toLocaleDateString()}</div>
                <div class="post-content">${post.content.substring(0, 100)}...</div>
            `;
					content.appendChild(postDiv);
				});
			} catch (error) {
				console.error('加载文章失败:', error);
			}
		}
		async function showPost(postId) {
			const postIdStr = String(postId);
			try {
				const { data, error } = await Supabase
					.from('posts')
					.select('*, users(username, avatar_url)')
					.eq('id', postIdStr)
					.limit(1);
				if (error) {
					console.error('查询文章时发生错误:', error);
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `加载文章失败: ${error.message}`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				if (!data || data.length === 0) {
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `文章不存在或您无权访问。`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				const post = data[0];
				if (!post) {
					const errorBox = document.createElement('div');
					errorBox.className = 'error';
					errorBox.textContent = `获取文章失败: 数据为空。`;
					document.querySelector('.content-grid').appendChild(errorBox);
					return;
				}
				document.querySelector('.intro-box').style.display = 'none';
				document.querySelector('.new-problems-box').style.display = 'none';
				document.querySelector('.comments-box').style.display = 'none';
				const postBox = document.createElement('div');
				postBox.className = 'box';
				const postTitle = post.title || '无标题';
				const postContent = post.content || '';
				const postAuthor = post.users?.username || '未知作者';
				const postDate = new Date(post.created_at).toLocaleString() || '未知时间';
				const postContentHtml = marked.parse(postContent);
				postBox.innerHTML = `
            <h1 class="box-title">${postTitle}</h1>
            <div class="post-meta">作者: ${postAuthor} | 发布时间: ${postDate}</div>
            <div class="markdown-content" id="post-content">${postContentHtml}</div>
        `;
				document.querySelector('.content-grid').insertBefore(postBox, document.querySelector('.comments-box'));
				await renderMath(postBox);
				addCopyButtonsToElement(postBox);
				showComments('post', postIdStr);
				if (currentUser && currentUser.id && post.user_id && currentUser.id === post.user_id) {
					const actions = document.createElement('div');
					actions.style.marginTop = '20px';
					actions.innerHTML = `
                <button class="profile-btn" onclick="deletePost('${postIdStr}')">删除文章</button>
            `;
					postBox.appendChild(actions);
				}
			} catch (error) {
				console.error('加载文章失败 (catch block):', error);
				const errorBox = document.createElement('div');
				errorBox.className = 'error';
				errorBox.textContent = `加载文章失败: ${error.message}`;
				document.querySelector('.content-grid').appendChild(errorBox);
			}
		}
		function editPost(id, title, content) {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			const editBox = document.createElement('div');
			editBox.className = 'post-form';
			editBox.innerHTML = `
        <h3>编辑文章</h3>
        <form class="post-form" id="post-form">
            <input type="text" id="edit-post-title" placeholder="标题" value="${title}">
            <textarea id="edit-post-content" placeholder="内容">${content}</textarea>
            <button type="button" class="profile-btn" onclick="updatePost('${id}')">更新</button>
        </form>
    `;
			document.querySelector('.content-grid').appendChild(editBox);
		}
		async function updatePost(id) {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			const title = document.getElementById('edit-post-title').value;
			const content = document.getElementById('edit-post-content').value;
			try {
				const { error } = await Supabase
					.from('posts')
					.update({ title, content })
					.eq('id', id);
				if (error) throw error;
				alert('文章更新成功！');
				window.location.reload();
			} catch (error) {
				alert('更新失败: ' + error.message);
			}
		}
		async function deletePost(id) {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			if (!confirm('确定要删除这篇文章吗？')) return;
			try {
				const { error } = await Supabase
					.from('posts')
					.delete()
					.eq('id', id);
				if (error) throw error;
				alert('文章删除成功！');
				window.location.href = window.location.origin + window.location.pathname;
			} catch (error) {
				alert('删除失败: ' + error.message);
			}
		}
		function createPost() {
			if (!currentUser) {
				alert('请先登录');
				return;
			}
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			const postBox = document.createElement('div');
			postBox.className = 'post-form';
			postBox.innerHTML = `
        <h1 class="box-title"><i class="fas fa-plus"></i> 创建新文章</h1>
        <form class="post-form" id="create-post-form">
            <input type="text" id="create-post-title" placeholder="标题">
            <textarea id="create-post-content" placeholder="内容"></textarea>
            <button type="button" class="profile-btn" onclick="savePost()">发布</button>
        </form>
    `;
			document.querySelector('.content-grid').appendChild(postBox);
		}
		async function savePost() {
			const title = document.getElementById('create-post-title').value;
			const content = document.getElementById('create-post-content').value;
			if (!title || !content) {
				alert('请输入标题和内容');
				return;
			}
			try {
				const { error } = await Supabase
					.from('posts')
					.insert([{
						user_id: currentUser.id,
						title,
						content
					}]);
				if (error) throw error;
				alert('文章发布成功！');
				window.location.href = window.location.origin + window.location.pathname;
			} catch (error) {
				alert('发布失败: ' + error.message);
			}
		}
		async function showComments(type, id) {
			const commentBox = document.createElement('div');
			commentBox.className = 'comment-box';
			commentBox.innerHTML = `
        <h3>评论</h3>
        <div class="comment-form">
            <textarea id="comment-content" placeholder="留下你的足迹……" ${currentUser ? '' : 'disabled'}></textarea>
            <button class="profile-btn" onclick="addComment('${type}', '${id}')" ${currentUser ? '' : 'disabled'}>发表评论</button>
        </div>
        <div id="comments-list"></div>
    `;
			document.querySelector('.content-grid').appendChild(commentBox);
			loadComments(type, id);
		}
		async function loadComments(type, id) {
			try {
				let query = Supabase
					.from('comments')
					.select('*, users(username, avatar_url)')
					.order('created_at', { ascending: true });
				if (type === 'problem') {
					query = query.eq('problem_id', id);
				} else if (type === 'post') {
					query = query.eq('post_id', id);
				}
				const { data, error } = await query;
				if (error) throw error;
				const list = document.getElementById('comments-list');
				list.innerHTML = '';
				data.forEach(comment => {
					const commentDiv = document.createElement('div');
					commentDiv.className = 'comment-item';
					const commentContentHtml = marked.parse(comment.content);
					commentDiv.innerHTML = `
                <div class="comment-header">
                    <img src="${comment.users?.avatar_url || 'https://cdn.luogu.com.cn/upload/image_hosting/t7nh8xao.png'}" alt="Avatar" class="comment-avatar">
                    <span class="comment-username">${comment.users?.username}</span>
                    <span class="comment-date">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <div class="comment-content markdown-content" id="comment-content-${comment.id}">${commentContentHtml}</div>
                <div id="reply-${comment.id}" class="reply-form" style="display: none;">
                    <textarea placeholder="回复内容..."></textarea>
                    <button onclick="addReply('${comment.id}', '${type}', '${id}')">发送</button>
                </div>
            `;
					list.appendChild(commentDiv);
					const contentElement = document.getElementById(`comment-content-${comment.id}`);
					if (contentElement) {
						renderMath(contentElement);
						addCopyButtonsToElement(contentElement);
					}
				});
			} catch (error) {
				console.error('加载评论失败:', error);
			}
		}
		function addCopyButtonsToElement(element) {
			if (window.hljs) {
				hljs.highlightAll({ container: element });
			} else {
				console.warn("Highlight.js library not found. Cannot highlight code blocks.");
			}
			const preElements = element.querySelectorAll('pre code');
			preElements.forEach(codeElement => {
				if (!codeElement.parentElement.querySelector('.codecopy-btn')) {
					const button = document.createElement('button');
					button.innerHTML = '<i class="fa-solid fa-copy"></i>';
					button.classList.add('codecopy-btn');
					const div = document.createElement('div');
					div.style = "width:100%;position:relative;";
					div.appendChild(button);
					codeElement.before(div);
					new ClipboardJS(button, {
						text: () => codeElement.innerText.replace(/\n/g, "\n")
					}).on('success', e => {
						e.trigger.innerHTML = '<i class="fa-solid fa-check"></i>';
						setTimeout(() => e.trigger.innerHTML = '<i class="fa-solid fa-copy"></i>', 1000);
					}).on('error', e => {
						e.trigger.innerHTML = '<i class="fa-solid fa-xmark"></i>';
						setTimeout(() => e.trigger.innerHTML = '<i class="fa-solid fa-copy"></i>', 1000);
					});
				}
			});
		}
		async function addComment(type, id) {
			if (!currentUser) {
				alert('请先登录');
				return;
			}
			const content = document.getElementById('comment-content').value;
			if (!content.trim()) {
				alert('请输入评论内容');
				return;
			}
			try {
				let commentData = {
					user_id: currentUser.id,
					content: content
				};
				if (type === 'problem') {
					commentData.problem_id = id;
				} else if (type === 'post') {
					commentData.post_id = id;
				}
				const { error } = await Supabase
					.from('comments')
					.insert([commentData]);
				if (error) throw error;
				document.getElementById('comment-content').value = '';
				loadComments(type, id);
			} catch (error) {
				alert('发表评论失败: ' + error.message);
				console.error('发表评论错误:', error);
			}
		}
		function showReply(commentId) {
			const replyForm = document.getElementById(`reply-${commentId}`);
			if (replyForm.style.display === 'none') {
				replyForm.style.display = 'block';
			} else {
				replyForm.style.display = 'none';
			}
		}
		async function addReply(parentId, type, id) {
			if (!currentUser) {
				alert('请先登录');
				return;
			}
			const textarea = document.querySelector(`#reply-${parentId} textarea`);
			const content = textarea.value;
			if (!content.trim()) {
				alert('请输入回复内容');
				return;
			}
			try {
				let commentData = {
					user_id: currentUser.id,
					content: content,
					parent_id: parentId
				};
				if (type === 'problem') {
					commentData.problem_id = id;
				} else if (type === 'post') {
					commentData.post_id = id;
				}
				const { error } = await Supabase
					.from('comments')
					.insert([commentData]);
				if (error) throw error;
				textarea.value = '';
				document.getElementById(`reply-${parentId}`).style.display = 'none';
				loadComments(type, id);
			} catch (error) {
				alert('发表回复失败: ' + error.message);
				console.error('发表回复错误:', error);
			}
		}
		document.addEventListener('DOMContentLoaded', function () {
			const sidebar = document.getElementById('sidebar');
			function expandSidebar() {
				if (sidebar) {
					sidebar.classList.add('expanded');
				}
			}
			function collapseSidebar() {
				if (sidebar) {
					sidebar.classList.remove('expanded');
				}
			}
			if (sidebar) {
				sidebar.addEventListener('touchstart', function (event) {
					expandSidebar();
				});
				sidebar.addEventListener('touchend', function (event) {
					collapseSidebar();
				});
				sidebar.addEventListener('touchleave', function (event) {
					collapseSidebar();
				});
				sidebar.addEventListener('touchcancel', function (event) {
					collapseSidebar();
				});
			}
		});
		document.addEventListener('DOMContentLoaded', function () {
			const sidebar = document.getElementById('sidebar');
			if (sidebar) {
				sidebar.addEventListener('mouseenter', function () {
					sidebar.classList.add('expanded');
				});
				sidebar.addEventListener('mouseleave', function () {
					sidebar.classList.remove('expanded');
				});
			}
		});
		function addCopyButtons() {
			if (window.hljs) {
				hljs.highlightAll();
			} else {
				console.warn("Highlight.js library not found. Cannot highlight code blocks.");
			}
			const preElements = document.querySelectorAll('pre code');
			preElements.forEach(codeElement => {
				if (!codeElement.parentElement.querySelector('.codecopy-btn')) {
					const button = document.createElement('button');
					button.innerHTML = '<i class="fa-solid fa-copy"></i>';
					button.classList.add('codecopy-btn');
					const div = document.createElement('div');
					div.style = "width:100%;position:relative;";
					div.appendChild(button);
					codeElement.before(div);
					new ClipboardJS(button, {
						text: () => codeElement.innerText.replace(/\n/g, "\n")
					}).on('success', e => {
						e.trigger.innerHTML = '<i class="fa-solid fa-check"></i>';
						setTimeout(() => e.trigger.innerHTML = '<i class="fa-solid fa-copy"></i>', 1000);
					}).on('error', e => {
						e.trigger.innerHTML = '<i class="fa-solid fa-xmark"></i>';
						setTimeout(() => e.trigger.innerHTML = '<i class="fa-solid fa-copy"></i>', 1000);
					});
				}
			});
		}
		async function renderMath(element) {
			if (window.renderMathInElement) {
				if (window.katex) {
					renderMathInElement(element, {
						delimiters: [
							{ left: "$$", right: "$$", display: true },
							{ left: "\\[", right: "\\]", display: true },
							{ left: "\\(", right: "\\)", display: false },
							{ left: "$", right: "$", display: false }
						],
						throwOnError: false
					});
				} else {
					console.warn("KaTeX core not loaded yet.");
					setTimeout(() => renderMath(element), 100);
				}
			} else {
				console.warn("KaTeX auto-render script not loaded yet.");
				setTimeout(() => renderMath(element), 100);
			}
			addCopyButtons();
		}
		async function loadIntro() {
			try {
				const response = await fetch('https://raw.bgithub.xyz/SnakeBloc-zym/SnakeBloc-zym.github.io/refs/heads/main/sources/index.md');
				if (!response.ok) throw new Error('无法加载介绍内容');
				const markdown = await response.text();
				const introContent = document.getElementById('intro-content');
				introContent.innerHTML = marked.parse(markdown);
				await new Promise(resolve => setTimeout(resolve, 0));
				await renderMath(introContent);
			} catch (error) {
				document.getElementById('intro-content').innerHTML =
					`<div class="error">加载介绍内容时出错: ${error.message}</div>`;
			}
		}
		async function loadNewProblems() {
			try {
				const response = await fetch('https://raw.bgithub.xyz/SnakeBloc-zym/SnakeBloc-zym.github.io/refs/heads/main/sources/newp.json');
				if (!response.ok) throw new Error('无法加载最新题目');
				const data = await response.json();
				const problemsContent = document.getElementById('new-problems-content');
				if (data.problems && data.problems.length > 0) {
					let html = '<ul class="problem-list">';
					data.problems.forEach(problem => {
						html += `
            <li class="problem-item">
              <a href="?id=${problem.id}" class="problem-link">${problem.title}</a>
              <div class="problem-meta">
                <span>难度: ${problem.difficulty}</span>
                <span>${problem.date}</span>
              </div>
            </li>
          `;
					});
					html += '</ul>';
					problemsContent.innerHTML = html;
				} else {
					problemsContent.innerHTML = '<p>暂无最新题目</p>';
				}
			} catch (error) {
				document.getElementById('new-problems-content').innerHTML =
					`<div class="error">加载最新题目时出错: ${error.message}</div>`;
			}
		}
		function showProblemList() {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			let problemListBox = document.getElementById('problem-list-box');
			if (!problemListBox) {
				problemListBox = document.createElement('div');
				problemListBox.id = 'problem-list-box';
				problemListBox.className = 'box';
				problemListBox.innerHTML = `
            <h2 class="box-title"><i class="fas fa-book"></i> 题库</h2>
            <div class="search-box" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="search-input" placeholder="搜索题目..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <select id="search-type" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="title">按标题搜索</option>
                        <option value="content">按内容搜索</option>
                    </select>
                    <button onclick="searchProblems()" style="padding: 10px 20px; background: #6a8cff; color: white; border: none; border-radius: 5px; cursor: pointer;"><i class="fas fa-search"></i> 搜索</button>
                </div>
                <div id="search-stats" style="color: #666; font-size: 0.9rem;"></div>
            </div>
            <div id="problem-list-content">
                <div class="loading">加载中...</div>
            </div>
        `;
				document.querySelector('.content-grid').insertBefore(problemListBox, document.querySelector('.comments-box'));
			}
			problemListBox.style.display = 'block';
			loadProblemList();
		}
		async function loadProblemList() {
			try {
				const response = await fetch('https://raw.bgithub.xyz/SnakeBloc-zym/SnakeBloc-zym.github.io/refs/heads/main/sources/p.json');
				if (!response.ok) throw new Error('无法加载题目列表');
				const problemList = await response.json();
				const problemListContent = document.getElementById('problem-list-content');
				window.allProblems = problemList;
				displayProblems(problemList);
			} catch (error) {
				document.getElementById('problem-list-content').innerHTML =
					`<div class="error">加载题目列表时出错: ${error.message}</div>`;
			}
		}
		function displayProblems(problems) {
			const problemListContent = document.getElementById('problem-list-content');
			if (problems && problems.length > 0) {
				let html = `
            <div style="margin-bottom: 15px; color: #666;">
                共找到 ${problems.length} 个题目
            </div>
            <ul class="problem-list">
        `;
				problems.forEach(problem => {
					html += `
                <li class="problem-item">
                    <a href="?id=${problem.id}" class="problem-link">${problem.title}</a>
                    <div class="problem-meta">
                        <span>ID: ${problem.id}</span>
                        <span>难度: ${problem.difficulty || '未知'}</span>
                        <span>${problem.date || ''}</span>
                    </div>
                    ${problem.tags ? `<div style="margin-top: 5px; font-size: 0.8rem; color: #888;">标签: ${problem.tags.join(', ')}</div>` : ''}
                </li>
            `;
				});
				html += '</ul>';
				problemListContent.innerHTML = html;
				document.getElementById('search-stats').textContent = `共找到 ${problems.length} 个题目`;
			} else {
				problemListContent.innerHTML = '<p>暂无题目</p>';
				document.getElementById('search-stats').textContent = '未找到相关题目';
			}
		}
		async function searchProblems() {
			const searchInput = document.getElementById('search-input');
			const searchType = document.getElementById('search-type');
			const keyword = searchInput.value.trim().toLowerCase();
			if (!keyword) {
				displayProblems(window.allProblems);
				return;
			}
			const problemListContent = document.getElementById('problem-list-content');
			problemListContent.innerHTML = '<div class="loading">搜索中...</div>';
			try {
				let filteredProblems = [];
				if (searchType.value === 'title') {
					filteredProblems = window.allProblems.filter(problem =>
						problem.title.toLowerCase().includes(keyword)
					);
				} else {
					filteredProblems = [];
					const searchPromises = window.allProblems.map(async (problem) => {
						try {
							const response = await fetch(`https://raw.bgithub.xyz/SnakeBloc-zym/SnakeBloc-zym.github.io/refs/heads/main/sources/problem/${problem.id}.md`);
							if (response.ok) {
								const content = await response.text();
								if (content.toLowerCase().includes(keyword)) {
									return problem;
								}
							}
						} catch (error) {
							console.error(`加载题目 ${problem.id} 内容失败:`, error);
						}
						return null;
					});
					const results = await Promise.all(searchPromises);
					filteredProblems = results.filter(problem => problem !== null);
				}
				displayProblems(filteredProblems);
			} catch (error) {
				problemListContent.innerHTML =
					`<div class="error">搜索时出错: ${error.message}</div>`;
			}
		}
		document.addEventListener('DOMContentLoaded', async function () {
			document.querySelector('.intro-box').style.display = 'none';
			document.querySelector('.new-problems-box').style.display = 'none';
			document.querySelector('.comments-box').style.display = 'none';
			await initAuth();
			const urlParams = new URLSearchParams(window.location.search);
			const problemId = urlParams.get('id');
			const page = urlParams.get('page');
			const userId = urlParams.get('user');
			const postId = urlParams.get('post');
			if (postId) {
				showPost(postId);
			} else if (userId) {
				showUserProfile(userId);
			} else if (page === 'problemlist') {
				showProblemList();
			} else if (page === 'clipboard') {
				showClipboard();
			} else if (page === 'posts') {
				showPosts();
			} else if (page === 'create-post') {
				createPost();
			} else if (problemId) {
				document.querySelector('.intro-box').style.display = 'none';
				document.querySelector('.new-problems-box').style.display = 'none';
				document.querySelector('.comments-box').style.display = 'none';
				const problemBox = document.createElement('div');
				problemBox.className = 'box';
				problemBox.innerHTML = `
            <div class="markdown-content" id="problem-content">
                <div class="loading">加载中...</div>
            </div>
        `;
				document.querySelector('.content-grid').insertBefore(problemBox, document.querySelector('.comments-box'));
				const mdUrl = `https://raw.bgithub.xyz/SnakeBloc-zym/SnakeBloc-zym.github.io/refs/heads/main/sources/problem/${problemId}.md`;
				fetch(mdUrl)
					.then(response => {
						if (!response.ok) throw new Error('题目不存在');
						return response.text();
					})
					.then(markdown => {
						document.getElementById('problem-content').innerHTML = marked.parse(markdown);
						if (window.renderMathInElement) {
							renderMathInElement(document.getElementById('problem-content'), {
								delimiters: [
									{ left: "$$", right: "$$", display: true },
									{ left: "\\[", right: "\\]", display: true },
									{ left: "\\(", right: "\\)", display: false },
									{ left: "$", right: "$", display: false }
								],
								throwOnError: false
							});
						}
						addCopyButtons();
						showComments('problem', problemId);
					})
					.catch(error => {
						document.getElementById('problem-content').innerHTML =
							`<div class="error">加载题目时出错: ${error.message}</div>`;
					});
			} else {
				document.querySelector('.intro-box').style.display = 'block';
				document.querySelector('.new-problems-box').style.display = 'block';
				document.querySelector('.comments-box').style.display = 'block';
				loadIntro();
				loadNewProblems();
			}
		});
		document.addEventListener('DOMContentLoaded', function () {
			const sidebar = document.getElementById('sidebar');
			if (sidebar) {
				const clipboardItem = document.createElement('div');
				clipboardItem.className = 'sidebar-item';
				clipboardItem.innerHTML = '<i class="fas fa-clipboard"></i><span>云剪贴板</span>';
				clipboardItem.onclick = () => {
					if (currentUser) {
						window.location.href = '?page=clipboard';
					} else {
						alert('请先登录');
					}
				};
				const postsItem = document.createElement('div');
				postsItem.className = 'sidebar-item';
				postsItem.innerHTML = '<i class="fas fa-newspaper"></i><span>文章</span>';
				postsItem.onclick = () => window.location.href = '?page=posts';
				const createPostItem = document.createElement('div');
				createPostItem.className = 'sidebar-item';
				createPostItem.innerHTML = '<i class="fas fa-plus"></i><span>发布文章</span>';
				createPostItem.onclick = () => {
					if (currentUser) {
						window.location.href = '?page=create-post';
					} else {
						alert('请先登录');
					}
				};
				sidebar.appendChild(clipboardItem);
				sidebar.appendChild(postsItem);
				sidebar.appendChild(createPostItem);
			}
		});
		document.addEventListener('DOMContentLoaded', function () {
			setTimeout(() => {
				const searchInput = document.getElementById('search-input');
				if (searchInput) {
					searchInput.addEventListener('keypress', function (e) {
						if (e.key === 'Enter') {
							searchProblems();
						}
					});
				}
			}, 100);
		});
		function initGiscus() {
			const giscusContainer = document.getElementById('giscus-comments');
			const script = document.createElement('script');
			script.src = 'https://giscus.app/client.js';
			script.setAttribute('data-repo', '[在此输入您的仓库]');
			script.setAttribute('data-repo-id', '[在此输入仓库ID]');
			script.setAttribute('data-category', '[在此输入分类]');
			script.setAttribute('data-category-id', '[在此输入分类ID]');
			script.setAttribute('data-mapping', 'pathname');
			script.setAttribute('data-strict', '0');
			script.setAttribute('data-reactions-enabled', '1');
			script.setAttribute('data-emit-metadata', '0');
			script.setAttribute('data-input-position', 'bottom');
			script.setAttribute('data-theme', 'dark');
			script.setAttribute('data-lang', 'zh-CN');
			script.setAttribute('crossorigin', 'anonymous');
			script.async = true;
			giscusContainer.appendChild(script);
		}
		document.addEventListener('DOMContentLoaded', () => {
			if (window.renderMathInElement) {
				renderMathInElement(document.body, {
					delimiters: [
						{ left: "$$", right: "$$", display: true },
						{ left: "\\[", right: "\\]", display: true },
						{ left: "\\(", right: "\\)", display: false },
						{ left: "$", right: "$", display: false }
					],
					throwOnError: false
				});
			}
		});
	</script>
	<script>
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', renderAllMath);
		} else {
			setTimeout(renderAllMath, 100);
		}
		function renderAllMath() {
			if (window.katex && window.renderMathInElement) {
				setTimeout(() => {
					renderMathInElement(document.body, {
						delimiters: [
							{ left: "$$", right: "$$", display: true },
							{ left: "\\[", right: "\\]", display: true },
							{ left: "\\(", right: "\\)", display: false },
							{ left: "$", right: "$", display: false }
						],
						throwOnError: false
					});
				}, 200);
			} else {
				setTimeout(renderAllMath, 100);
			}
		}
	</script>
</body>

</html>
